Zabbixサーバ上でコマンドを実行する手順
----

以下はサーバ上でコマンドが実行できることを確認したときの手順。

##### 1. サーバ上でエージェントを起動

```bash
$ sudo service zabbix-agent start
```

##### 2. ホストを登録

「設定」 -> 「ホスト」 -> 「ホストの作成」で、 「IPアドレス」にサーバの IP アドレスを入力し、「リンクしているテンプレート」のところで Template\_Linux を追加する。
ホスト名は「server」とする。

IP アドレスは「127.0.0.1」じゃないとダメっぽい？

##### 3. トリガーを設定

適当なトリガーを設定する。テストでは常に真になるようなトリガーを設定した。

1. 「設定」 -> 「ホスト」 -> コマンド実行したいサーバの「トリガー」 -> 「トリガーの作成」
2. 「条件式」の「追加」 -> 「アイテム」
3. 「選択」を「Buffers memory」、「機能」を「Last value > N」、「N」を「0」で「挿入」

あと

> トリガーを作成するときは必ず
ノーマル＋障害イベントを継続して生成
にして作成しましょう。でないとアクションが実行されません
<cite>http://kakakikikeke.blogspot.jp/2012/11/zabbix.html</cite>

だそうなので「ノーマル＋障害イベントを継続して生成」にしましょう。

##### 4. アクションを設定

アクションで実行したいコマンドを指定する。

1. 「設定」 -> 「アクション」 -> 「アクションの作成」
2. オペレーションの「新規」 -> 「オペレーションのタイプ」を「リモートコマンド」 -> 「リモートコマンド」に `server: touch /tmp/test` と入力、「保存」。 `>` とかでリダイレクトもできる
3. 「アクションのコンディション」でさっき設定したトリガーを入力

**注意** `zabbix` というユーザーで実行されるので、権限を適切に設定しておく必要がある。

##### 5. しばらく待つ

`/tmp/test` ファイルができればOK。トリガーとリモートコマンドを適当に変えれば任意のコマンドを実行できるはず。

エージェントの IP アドレスを取得
----

- 参考： <https://www.zabbix.com/documentation/doku.php?id=1.8/manual/config/macros>

3番目のトリガー上を引き起こしたホストの IP アドレスを `{IPADDRESS3}` のように取れる。1〜9まである。

しかし IP アドレスから SERVER_ID を引っ張ってくるのがめんどくさいので、スクリプトに引数で SERVER_ID を渡すようにした。

ユーザー定義変数
----

各ホストにユーザーで定義した変数をもたせることができる。ホスト設定画面の右側の「マクロ」

**注意** リモートコマンド実行時にはユーザー定義マクロは使えないらしい。1つずつアクションを作ってハードコードする必要がある。

- <https://www.zabbix.com/documentation/1.8/manual/config/macros>

>リモートコマンドには、標準のマクロを使用することができます。
<cite>http://www.zabicom.com/zabicom/monitoring.html</cite>

障害情報を DB に入れるスクリプト
----

- <https://github.com/worksap-ate/wc3/blob/daimatz/tools/zabbix-server/insert-incident-item.sh>